<app-top-bar backButtonTitle="{{ 'NAV.DATATARGET' | translate }}" title="{{ 'FORM.EDIT-DATATARGET' | translate }}">
</app-top-bar>

<form #datatargetForm="ngForm" (ngSubmit)="onSubmit()" class="os2-form p-3 mt-4">
  @if (errorMessages) {
    <div class="error-messages p-3">
      <ul class="mb-0">
        @for (error of errorMessages; track error) {
          <li>
            {{ error | translate }}
          </li>
        }
      </ul>
    </div>
  }

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="name">{{ "QUESTION.GIVE-DATATARGET-NAME" | translate }}</label
      >*
      <input
        [(ngModel)]="datatarget.name"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('name'),
          'is-valid': formFailedSubmit && !errorFields.includes('name')
        }"
        [placeholder]="'QUESTION.GIVE-DATATARGET-NAME-PLACEHOLDER' | translate"
        class="form-control"
        id="name"
        maxlength="50"
        name="name"
        required
        type="text"
      />
    </div>
  </div>

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="url">{{ "QUESTION.DATATARGET.MQTT.GIVE-URL" | translate }}</label
      >*
      <input
        [(ngModel)]="datatarget.url"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('url'),
          'is-valid': formFailedSubmit && !errorFields.includes('url')
        }"
        [placeholder]="'QUESTION.DATATARGET.MQTT.GIVE-URL-PLACEHOLDER' | translate"
        class="form-control"
        id="url"
        name="url"
        required
        type="text"
      />
    </div>
  </div>

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="mqtt-port">{{ "QUESTION.DATATARGET.MQTT.GIVE-PORT" | translate }}</label
      >*
      <input
        [(ngModel)]="datatarget.mqttPort"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('mqttPort'),
          'is-valid': formFailedSubmit && !errorFields.includes('mqttPort')
        }"
        [placeholder]="'QUESTION.DATATARGET.MQTT.GIVE-PORT-PLACEHOLDER' | translate"
        [required]="true"
        class="form-control"
        id="mqtt-port"
        max="65535"
        min="1025"
        name="mqtt-port"
        step="1"
        type="number"
      />
    </div>
  </div>

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="mqtt-qos">{{ "QUESTION.DATATARGET.MQTT.GIVE-QOS" | translate }}</label
      >*
      <fa-icon
        [icon]="faQuestionCircle"
        [matTooltip]="'QUESTION.DATATARGET.MQTT.GIVE-QOS-INFO' | translate"
        class="form-info-icon"
        matTooltipHideDelay="2000"
        matTooltipPosition="above"
        matTooltipShowDelay="600"
      ></fa-icon>
      <input
        [(ngModel)]="datatarget.mqttQos"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('mqttQos'),
          'is-valid': formFailedSubmit && !errorFields.includes('mqttQos')
        }"
        [placeholder]="'QUESTION.DATATARGET.MQTT.GIVE-QOS-PLACEHOLDER' | translate"
        [required]="true"
        class="form-control"
        id="mqtt-qos"
        max="2"
        min="0"
        name="mqtt-qos"
        step="1"
        type="number"
      />
    </div>
  </div>

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="mqtt-topic">{{ "QUESTION.DATATARGET.MQTT.GIVE-TOPIC" | translate }}</label
      >*
      <fa-icon
        [icon]="faQuestionCircle"
        [matTooltip]="'QUESTION.DATATARGET.MQTT.GIVE-TOPIC-INFO' | translate"
        class="form-info-icon"
        matTooltipHideDelay="2000"
        matTooltipPosition="above"
        matTooltipShowDelay="600"
      ></fa-icon>
      <input
        [(ngModel)]="datatarget.mqttTopic"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('mqttTopic'),
          'is-valid': formFailedSubmit && !errorFields.includes('mqttTopic')
        }"
        [placeholder]="'QUESTION.DATATARGET.MQTT.GIVE-TOPIC-PLACEHOLDER' | translate"
        class="form-control"
        id="mqtt-topic"
        name="mqtt-topic"
        required
        type="text"
      />
    </div>
  </div>

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="mqttUsername">{{ "QUESTION.DATATARGET.MQTT.GIVE-USERNAME" | translate }}</label
      >*
      <input
        [(ngModel)]="datatarget.mqttUsername"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('mqttUsername'),
          'is-valid': formFailedSubmit && !errorFields.includes('mqttUsername')
        }"
        [required]="true"
        class="form-control"
        id="mqttUsername"
        name="mqttUsername"
        type="text"
      />
    </div>
  </div>

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="mqttPassword">{{ "QUESTION.DATATARGET.MQTT.GIVE-PASSWORD" | translate }}</label
      >*
      <input
        [(ngModel)]="datatarget.mqttPassword"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('mqttPassword'),
          'is-valid': formFailedSubmit && !errorFields.includes('mqttPassword')
        }"
        [required]="true"
        class="form-control"
        id="mqttPassword"
        name="mqttPassword"
        type="password"
      />
    </div>
  </div>

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="timeout">{{ "QUESTION.GIVE-DATATARGET-TIMEOUT" | translate }}</label
      >*
      <input
        [(ngModel)]="datatarget.timeout"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('timeout'),
          'is-valid': formFailedSubmit && !errorFields.includes('timeout')
        }"
        class="form-control"
        id="timeout"
        max="100000"
        maxlength="7"
        min="0"
        name="timeout"
        required
        step="1"
        type="number"
      />
    </div>
  </div>

  @if (!datatargetId) {
    <div>
      <h6>{{ "QUESTION.DATATARGET.RELATIONS" | translate }}</h6>
    </div>
  } @if (datatargetId) {
  <div class="container row" class="mt-3">
    <a (click)="addRow()" class="btn btn-secondary my-2 mb-3 mt-3">{{ "QUESTION.ADD-RELATIONS" | translate }}</a>
    @if (devices && payloadDecoders && payloadDeviceDatatarget?.length > 0) {
      <table class="table table-striped table-bordered">
        <tbody>
        @for (element of payloadDeviceDatatarget; track element; let i = $index) {
          <tr [attr.data-index]="i">
            <td>
              <div class="row">
                <mat-form-field appearance="fill">
                  <mat-label>{{ "QUESTION.DATATARGET.SELECT-DEVICES" | translate }}</mat-label>
                  <mat-select [(value)]="element.iotDeviceIds" multiple name="devices">
                    <mat-option class="filter-option" disabled="disabled">
                      <button (click)="selectAllDevices(i)" class="mat-primary fill text-sm" mat-raised-button>
                        {{ "QUESTION.DATATARGET.SELECTALLDEVICES" | translate }}
                      </button>
                      <button (click)="deselectAllDevices(i)" class="mat-primary fill text-sm" mat-raised-button>
                        {{ "QUESTION.DATATARGET.DESELECTALLDEVICES" | translate }}
                      </button>
                    </mat-option>
                    @for (device of devices; track device) {
                      <mat-option [value]="device.id">{{ device.name }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>
            </td>
            <td>
              <div class="row">
                <mat-form-field appearance="fill">
                  <mat-label>{{ "QUESTION.DATATARGET.SELECT-PAYLOADDECODER" | translate }}</mat-label>
                  <mat-select [(value)]="element.payloadDecoderId" matNativeControl name="payloadDecoderId">
                    <mat-option [value]="0">
                      {{ "QUESTION.DATATARGET.NO-PAYLOAD-DECODER-SELECTED" | translate }}
                    </mat-option>
                    @for (payloadDecoder of payloadDecoders; track payloadDecoder) {
                      <mat-option [value]="payloadDecoder.id">
                        {{ payloadDecoder.name }}
                      </mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>
            </td>
            <td>
              <a (click)="openDeleteDialog(i)">
                <div class="text-center m-2">
                  <fa-icon [icon]="faTimesCircle"></fa-icon>
                  <p>{{ "DATATARGET.DELETE" | translate }}</p>
                </div>
              </a>
            </td>
          </tr>
        }
        </tbody>
      </table>
    }
  </div>
}

  <div class="form-group mt-5">
    <button (click)="routeToDatatargets()" class="btn btn-light" type="button">{{ "GEN.BACK" | translate }}</button>
    <button class="btn btn-primary ms-2" type="submit">{{ "DATATARGET.SAVE" | translate }}</button>
  </div>
</form>
