<app-top-bar [canEdit]="canEdit" backButtonTitle="{{ backButtonTitle }}" title="{{ title }}"></app-top-bar>

<form #datatargetForm="ngForm" (ngSubmit)="onSubmit()" class="os2-form p-3 mt-4">
  @if (errorMessages) {
    <div class="error-messages p-3">
      <ul class="mb-0">
        @for (error of errorMessages; track error) {
          <li>
            {{ error | translate }}
          </li>
        }
      </ul>
    </div>
  }

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="name">{{ "QUESTION.GIVE-DATATARGET-NAME" | translate }}</label
      >*
      <input
        [(ngModel)]="datatarget.name"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('name'),
          'is-valid': formFailedSubmit && !errorFields.includes('name')
        }"
        [placeholder]="'QUESTION.GIVE-DATATARGET-NAME-PLACEHOLDER' | translate"
        class="form-control"
        id="name"
        maxlength="50"
        name="name"
        required
        type="text"
      />
    </div>
  </div>

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="url">{{ "FIWARE.QUESTION.GIVE-DATATARGET-CONTEXTBROKER-URL" | translate }}</label
      >*
      <input
        [(ngModel)]="datatarget.url"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('url'),
          'is-valid': formFailedSubmit && !errorFields.includes('url')
        }"
        [placeholder]="'FIWARE.QUESTION.GIVE-DATATARGET-CONTEXTBROKER-URL-PLACEHOLDER' | translate"
        class="form-control"
        id="url"
        name="url"
        required
        type="text"
      />
    </div>
  </div>

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="url">{{ "FIWARE.QUESTION.GIVE-DATATARGET-TENANT" | translate }}</label>
      <fa-icon
        [icon]="faQuestionCircle"
        [matTooltip]="'FIWARE.QUESTION.GIVE-DATATARGET-TENANT-INFO' | translate"
        class="form-info-icon"
        matTooltipHideDelay="2000"
        matTooltipPosition="above"
        matTooltipShowDelay="600"
      ></fa-icon>
      <input
        [(ngModel)]="datatarget.tenant"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('tenant'),
          'is-valid': formFailedSubmit && !errorFields.includes('tenant')
        }"
        [placeholder]="'FIWARE.QUESTION.GIVE-DATATARGET-TENANT-PLACEHOLDER' | translate"
        class="form-control"
        id="tenant"
        name="tenant"
        required
        type="text"
      />
    </div>
  </div>

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="url">{{ "FIWARE.QUESTION.GIVE-DATATARGET-CONTEXT" | translate }}</label>
      <fa-icon
        [icon]="faQuestionCircle"
        [matTooltip]="'FIWARE.QUESTION.GIVE-DATATARGET-CONTEXT-INFO' | translate"
        class="form-info-icon"
        matTooltipHideDelay="2000"
        matTooltipPosition="above"
        matTooltipShowDelay="600"
      ></fa-icon>
      <input
        [(ngModel)]="datatarget.context"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('context'),
          'is-valid': formFailedSubmit && !errorFields.includes('context')
        }"
        [placeholder]="'FIWARE.QUESTION.GIVE-DATATARGET-CONTEXT-PLACEHOLDER' | translate"
        class="form-control"
        id="context"
        name="context"
        required
        type="text"
      />
    </div>
  </div>

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="timeout">{{ "QUESTION.GIVE-DATATARGET-TIMEOUT" | translate }}</label
      >*
      <input
        [(ngModel)]="datatarget.timeout"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('timeout'),
          'is-valid': formFailedSubmit && !errorFields.includes('timeout')
        }"
        class="form-control"
        id="timeout"
        max="100000"
        maxlength="7"
        min="0"
        name="timeout"
        required
        step="1"
        type="number"
      />
    </div>
  </div>

  <div class="row mb-2">
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="authorizationHeader">{{
          "QUESTION.GIVE-DATATARGET-AUTHORIZATIONHEADER" | translate
        }}</label>
      <input
        [(ngModel)]="datatarget.authorizationHeader"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('authorizationHeader'),
          'is-valid': formFailedSubmit && !errorFields.includes('authorizationHeader')
        }"
        class="form-control"
        id="authorizationHeader"
        name="authorizationHeader"
        required
        type="text"
      />
    </div>
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="tokenEndpoint">{{
          "FIWARE.QUESTION.GIVE-DATATARGET-TOKENENDPOINT" | translate
        }}</label>
      <input
        [(ngModel)]="datatarget.tokenEndpoint"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('tokenEndpoint'),
          'is-valid': formFailedSubmit && !errorFields.includes('tokenEndpoint')
        }"
        [placeholder]="'FIWARE.QUESTION.GIVE-DATATARGET-TOKENENDPOINT-PLACEHOLDER' | translate"
        class="form-control"
        id="tokenEndpoint"
        name="tokenEndpoint"
        required
        type="text"
      />
    </div>
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="clientId">{{ "FIWARE.QUESTION.GIVE-DATATARGET-CLIENTID" | translate }}</label>
      <input
        [(ngModel)]="datatarget.clientId"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('clientId'),
          'is-valid': formFailedSubmit && !errorFields.includes('clientId')
        }"
        [placeholder]="'FIWARE.QUESTION.GIVE-DATATARGET-CLIENTID-PLACEHOLDER' | translate"
        class="form-control"
        id="clientId"
        name="clientId"
        required
        type="text"
      />
    </div>
    <div class="form-group mt-3 col-12">
      <label class="form-label" for="clientSecret">{{
          "FIWARE.QUESTION.GIVE-DATATARGET-CLIENTSECRET" | translate
        }}</label>
      <input
        [(ngModel)]="datatarget.clientSecret"
        [ngClass]="{
          'is-invalid': formFailedSubmit && errorFields.includes('clientSecret'),
          'is-valid': formFailedSubmit && !errorFields.includes('clientSecret')
        }"
        [placeholder]="'FIWARE.QUESTION.GIVE-DATATARGET-CLIENTSECRET-PLACEHOLDER' | translate"
        class="form-control"
        id="clientSecret"
        name="clientSecret"
        required
        type="password"
      />
    </div>
    @if (datatargetid === 0) {
      <div>
        <h6>{{ "QUESTION.DATATARGET.RELATIONS" | translate }}</h6>
      </div>
    } @if (datatargetid > 0) {
    <div class="container row" class="mt-3">
      <a (click)="addRow()" class="btn btn-secondary my-2 mb-3 mt-3">{{ "QUESTION.ADD-RELATIONS" | translate }}</a>
      @if (devices && payloadDecoders && payloadDeviceDatatarget?.length > 0) {
        <table class="table table-striped table-bordered">
          <tbody>
          @for (element of payloadDeviceDatatarget; track element; let i = $index) {
            <tr [attr.data-index]="i">
              <td>
                <div class="row">
                  <mat-form-field appearance="fill">
                    <mat-label>{{ "QUESTION.DATATARGET.SELECT-DEVICES" | translate }}</mat-label>
                    <mat-select [(value)]="element.iotDeviceIds" [compareWith]="compare" multiple name="devices">
                      <button (click)="selectAllDevices(i)" class="mat-primary fill text-sm" mat-raised-button>
                        {{ "QUESTION.DATATARGET.SELECTALLDEVICES" | translate }}
                      </button>
                      <button (click)="deSelectAllDevices(i)" class="mat-primary fill text-sm" mat-raised-button>
                        {{ "QUESTION.DATATARGET.DESELECTALLDEVICES" | translate }}
                      </button>
                      @for (device of devices; track device) {
                        <mat-option [value]="device.id">{{ device.name }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
              </td>
              <td>
                <div class="row">
                  <mat-form-field appearance="fill">
                    <mat-label>{{ "QUESTION.DATATARGET.SELECT-PAYLOADDECODER" | translate }}</mat-label>
                    <mat-select [(value)]="element.payloadDecoderId" matNativeControl name="payloadDecoderId">
                      <mat-option [value]="0">
                        {{ "QUESTION.DATATARGET.NO-PAYLOAD-DECODER-SELECTED" | translate }}
                      </mat-option>
                      @for (payloadDecoder of payloadDecoders; track payloadDecoder) {
                        <mat-option [value]="payloadDecoder.id">
                          {{ payloadDecoder.name }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
              </td>
              <td>
                <a (click)="openDeleteDialog(i)">
                  <div class="text-center m-2">
                    <fa-icon [icon]="faTimesCircle"></fa-icon>
                    <p>{{ "DATATARGET.DELETE" | translate }}</p>
                  </div>
                </a>
              </td>
            </tr>
          }
          </tbody>
        </table>
      }
    </div>
  }

    <div class="form-group mt-5">
      <button (click)="routeToDatatargets()" class="btn btn-light" type="button">
        {{ "GEN.BACK" | translate }}
      </button>
      <button [disabled]="disableSaveButton()" class="btn btn-primary ms-2" type="submit">
        {{ submitButton }}
      </button>
    </div>
  </div>
</form>
